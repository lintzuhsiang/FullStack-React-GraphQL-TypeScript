var e = require("react");

var t = require("react-ssr-prepass");

var n = require("urql");

function _interopDefaultLegacy(e) {
  return e && "object" == typeof e && "default" in e ? e.default : e;
}

var r = _interopDefaultLegacy(t);

function _extends() {
  return (_extends = Object.assign || function(e) {
    for (var t = 1; t < arguments.length; t++) {
      var n = arguments[t];
      for (var r in n) {
        if (Object.prototype.hasOwnProperty.call(n, r)) {
          e[r] = n[r];
        }
      }
    }
    return e;
  }).apply(this, arguments);
}

var i = null;

function resetClient() {
  i = null;
}

function initUrqlClient(e, t) {
  var r = "undefined" == typeof window;
  if (r || !i) {
    (i = n.createClient(_extends({}, e, {
      suspense: t && (r || e.suspense)
    }))).toJSON = function() {
      return null;
    };
  }
  return i;
}

var a;

exports.initUrqlClient = initUrqlClient;

exports.withUrqlClient = function withUrqlClient(t, i) {
  if (!i) {
    i = {};
  }
  return function(l) {
    var u = Boolean((l.getInitialProps || i.ssr) && !i.neverSuspend);
    var WithUrql = function(r) {
      var i = r.pageProps;
      var o = r.urqlClient;
      var s = r.urqlState;
      var c = function objectWithoutProperties(e, t) {
        var n = {};
        for (var r in e) {
          if (Object.prototype.hasOwnProperty.call(e, r) && -1 === t.indexOf(r)) {
            n[r] = e[r];
          }
        }
        return n;
      }(r, [ "pageProps", "urqlClient", "urqlState" ]);
      var f = e.useReducer((function(e) {
        return e + 1;
      }), 0);
      var p = f[0];
      var v = f[1];
      var d = i && i.urqlState || s;
      var h = e.useMemo((function() {
        if (o && !p) {
          return o;
        }
        if (!a || "undefined" == typeof window) {
          a = n.ssrExchange({
            initialState: d,
            isClient: !0
          });
        } else if (!p) {
          a.restoreData(d);
        }
        var e = t(a);
        if (!e.exchanges) {
          e.exchanges = [ n.dedupExchange, n.cacheExchange, a, n.fetchExchange ];
        }
        return initUrqlClient(e, u);
      }), [ o, d, p ]);
      var g = e.useCallback((function() {
        resetClient();
        a = n.ssrExchange({
          initialState: void 0
        });
        v();
      }), []);
      return e.createElement(n.Provider, {
        value: h
      }, e.createElement(l, _extends({}, c, {
        pageProps: i,
        urqlClient: h,
        resetUrqlClient: g
      })));
    };
    WithUrql.displayName = "withUrqlClient(" + (l.displayName || l.name || "Component") + ")";
    if (l.getInitialProps || i.ssr) {
      WithUrql.getInitialProps = function(a) {
        try {
          function _temp4() {
            function _temp2() {
              return _extends({}, v, {
                urqlState: c ? c.extractData() : void 0,
                urqlClient: p
              });
            }
            if ("undefined" != typeof window) {
              return _extends({}, v, {
                urqlClient: p
              });
            }
            var t = _extends({}, v, {
              urqlClient: p
            });
            var n = o ? t : {
              pageProps: t
            };
            const a = function() {
              if (!i.neverSuspend) {
                return Promise.resolve(r(e.createElement(u, n))).then((function() {}));
              }
            }();
            return a && a.then ? a.then(_temp2) : _temp2();
          }
          var u = a.AppTree;
          var o = !!a.Component;
          var s = o ? a.ctx : a;
          var c = n.ssrExchange({
            initialState: void 0
          });
          var f = t(c, s);
          if (!f.exchanges) {
            f.exchanges = [ n.dedupExchange, n.cacheExchange, c, n.fetchExchange ];
          }
          var p = initUrqlClient(f, !i.neverSuspend);
          if (p) {
            s.urqlClient = p;
          }
          var v = {};
          const d = function() {
            if (l.getInitialProps) {
              return Promise.resolve(l.getInitialProps(a)).then((function(e) {
                v = e;
              }));
            }
          }();
          return Promise.resolve(d && d.then ? d.then(_temp4) : _temp4());
        } catch (e) {
          return Promise.reject(e);
        }
      };
    }
    return WithUrql;
  };
};
//# sourceMappingURL=next-urql.js.map
